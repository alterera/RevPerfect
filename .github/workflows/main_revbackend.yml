name: Build and deploy Node.js app to Azure Web App - RevPerfect-Backend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install dependencies and build
        working-directory: ./backend
        run: |
          npm install
          npm run build

      - name: Prepare deployment package
        run: |
          mkdir deploy
          cp -r backend/dist deploy/dist
          cp -r backend/prisma deploy/prisma
          cp backend/package.json deploy/
          cp backend/package-lock.json deploy/
          
          # Create Azure deployment configuration
          cat > deploy/.deployment << 'EOF'
[config]
SCM_DO_BUILD_DURING_DEPLOYMENT = false
EOF
          
          # Create web.config for proper routing
          cat > deploy/web.config << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode"/>
    </handlers>
    <rewrite>
      <rules>
        <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
          <match url="^server.js\/debug[\/]?" />
        </rule>
        <rule name="StaticContent">
          <action type="Rewrite" url="public{REQUEST_URI}"/>
        </rule>
        <rule name="DynamicContent">
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
          </conditions>
          <action type="Rewrite" url="server.js"/>
        </rule>
      </rules>
    </rewrite>
    <iisnode watchedFiles="web.config;*.js"/>
  </system.webServer>
</configuration>
EOF
          
          # Create a Node.js startup script
          cat > deploy/server.js << 'EOF'
const { execSync } = require('child_process');

console.log('=== Starting RevPerfect Backend ===');
console.log('Current directory:', process.cwd());
console.log('Node version:', process.version);

try {
  console.log('Generating Prisma Client...');
  execSync('npx prisma generate', { 
    stdio: 'inherit',
    cwd: process.cwd(),
    env: process.env
  });
  console.log('✓ Prisma Client generated successfully');
} catch (error) {
  console.error('✗ Failed to generate Prisma Client:', error.message);
  process.exit(1);
}

console.log('Starting application...');
require('./dist/index.js');
EOF

      - name: Install production dependencies and generate Prisma client
        working-directory: ./deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npm install --omit=dev
          npx prisma generate
          
          # Update package.json to use server.js as entry point
          node -e "const pkg = require('./package.json'); pkg.scripts.start = 'node server.js'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

      - name: Zip deployment package
        run: |
          cd deploy
          zip -r ../deploy.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'production'

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: Unzip deployment package
        run: unzip deploy.zip -d deploy

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'revbackend'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy
        env:
          SCM_DO_BUILD_DURING_DEPLOYMENT: false
